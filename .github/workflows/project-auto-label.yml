name: Auto-label issues and PRs

on:
  issues:
    types: [opened]
  pull_request:
    types: [opened]

jobs:
  auto-label:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    steps:
      - name: Label based on title/branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EVENT_NAME: ${{ github.event_name }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
          REPO: ${{ github.repository }}
        run: |
          if [ "$EVENT_NAME" = "issues" ]; then
            TITLE="$ISSUE_TITLE"
            NUMBER="$ISSUE_NUMBER"
            TYPE="issue"
          else
            TITLE="$PR_TITLE"
            NUMBER="$PR_NUMBER"
            TYPE="pr"
            BRANCH="$PR_BRANCH"
          fi

          LABELS=""

          # Detect from title prefix
          case "$TITLE" in
            feat:*|feat\(*) LABELS="enhancement" ;;
            fix:*|fix\(*)   LABELS="bug" ;;
            docs:*|doc:*)   LABELS="documentation" ;;
            refactor:*)     LABELS="refactor" ;;
            test:*)         LABELS="test" ;;
            ci:*)           LABELS="ci" ;;
          esac

          # Detect from branch name for PRs
          if [ "$TYPE" = "pr" ] && [ -z "$LABELS" ]; then
            case "$BRANCH" in
              feature/*|feat/*) LABELS="enhancement" ;;
              fix/*|bugfix/*)   LABELS="bug" ;;
              hotfix/*)         LABELS="bug,urgent" ;;
              refactor/*)       LABELS="refactor" ;;
            esac
          fi

          # Detect from emoji in title
          if [ -z "$LABELS" ]; then
            case "$TITLE" in
              *üêõ*|*üêû*) LABELS="bug" ;;
              *‚ú®*|*üöÄ*) LABELS="enhancement" ;;
              *üìù*|*üìñ*) LABELS="documentation" ;;
              *üì≤*)      LABELS="mobile" ;;
            esac
          fi

          if [ -n "$LABELS" ]; then
            # Ensure labels exist
            IFS=',' read -ra LABEL_ARRAY <<< "$LABELS"
            for LABEL in "${LABEL_ARRAY[@]}"; do
              gh label create "$LABEL" --repo "$REPO" 2>/dev/null || true
            done

            if [ "$TYPE" = "issue" ]; then
              gh issue edit "$NUMBER" --repo "$REPO" --add-label "$LABELS"
            else
              gh pr edit "$NUMBER" --repo "$REPO" --add-label "$LABELS"
            fi
            echo "Added labels: $LABELS"
          else
            echo "No labels to add"
          fi
